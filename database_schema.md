# PostgreSQL Database Schema for Yad2 CRM

This document outlines the database schema for the Yad2 CRM application.

## Tables

### 1. `users`

Stores information about registered clients.

| Column Name             | Data Type        | Constraints                                  | Description                                      |
|-------------------------|------------------|----------------------------------------------|--------------------------------------------------|
| `user_id`               | SERIAL           | PRIMARY KEY                                  | Unique identifier for the user.                  |
| `email`                 | VARCHAR(255)     | UNIQUE NOT NULL                              | User's email address (used for login).           |
| `password_hash`         | VARCHAR(255)     | NOT NULL                                     | Hashed password for the user.                    |
| `created_at`            | TIMESTAMP        | DEFAULT CURRENT_TIMESTAMP                    | Timestamp when the user account was created.     |
| `updated_at`            | TIMESTAMP        | DEFAULT CURRENT_TIMESTAMP                    | Timestamp when the user account was last updated. |
| `subscription_id`       | INTEGER          | REFERENCES subscriptions(subscription_id) NULL | Foreign key linking to the user's subscription.  |
| `whatsapp_qr_code`      | TEXT             | NULL                                         | Stores the current WhatsApp QR code for login.   |
| `whatsapp_session_data` | JSONB            | NULL                                         | Stores the whatsapp-web.js session data.         |
| `whatsapp_ready`        | BOOLEAN          | DEFAULT FALSE                                | Flag indicating if WhatsApp session is ready.    |

### 2. `subscriptions`

Stores information about user subscription plans.

| Column Name             | Data Type    | Constraints                               | Description                                      |
|-------------------------|--------------|-------------------------------------------|--------------------------------------------------|
| `subscription_id`       | SERIAL       | PRIMARY KEY                               | Unique identifier for the subscription.          |
| `user_id`               | INTEGER      | UNIQUE NOT NULL REFERENCES users(user_id) | Foreign key linking to the user.                 |
| `plan_type`             | VARCHAR(50)  | DEFAULT 'basic_monthly'                   | Type of subscription plan (e.g., 'basic_monthly'). |
| `status`                | VARCHAR(50)  | NOT NULL DEFAULT 'inactive'               | Subscription status (e.g., 'active', 'inactive'). |
| `start_date`            | TIMESTAMP    | NULL                                      | Date when the subscription started.              |
| `end_date`              | TIMESTAMP    | NULL                                      | Date when the subscription expires or ended.     |
| `stripe_customer_id`    | VARCHAR(255) | NULL                                      | Stripe customer ID for billing.                  |
| `stripe_subscription_id`| VARCHAR(255) | NULL                                      | Stripe subscription ID for billing.              |
| `created_at`            | TIMESTAMP    | DEFAULT CURRENT_TIMESTAMP                 | Timestamp when the subscription was created.     |
| `updated_at`            | TIMESTAMP    | DEFAULT CURRENT_TIMESTAMP                 | Timestamp when the subscription was last updated. |

### 3. `leads`

Stores information about scraped rental listings (leads).

| Column Name             | Data Type    | Constraints                       | Description                                                    |
|-------------------------|--------------|-----------------------------------|----------------------------------------------------------------|
| `lead_id`               | SERIAL       | PRIMARY KEY                       | Unique identifier for the lead.                                |
| `user_id`               | INTEGER      | NOT NULL REFERENCES users(user_id)| Foreign key linking the lead to a specific user.               |
| `yad2_listing_id`       | VARCHAR(255) | UNIQUE NOT NULL                   | Unique ID generated by the scraper (phone+address+date hash). |
| `owner_name`            | VARCHAR(255) | NULL                              | Name of the property owner/contact.                            |
| `phone_number`          | VARCHAR(50)  | NULL                              | Contact phone number for the lead.                             |
| `address`               | TEXT         | NULL                              | Full address of the property.                                  |
| `apartment_size`        | VARCHAR(50)  | NULL                              | Size of the apartment (sqm).                                   |
| `rooms_count`           | VARCHAR(50)  | NULL                              | Number of rooms in the apartment.                              |
| `publish_date`          | VARCHAR(50)  | NULL                              | Date the listing was published on Yad2.                        |
| `description`           | TEXT         | NULL                              | Description text from the listing.                             |
| `listing_url`           | TEXT         | NULL                              | Direct URL to the Yad2 listing.                                |
| `status`                | VARCHAR(50)  | DEFAULT 'new'                     | Current status of the lead (e.g., 'new', 'contacted').         |
| `scraped_at`            | TIMESTAMP    | NOT NULL                          | Timestamp when the listing was scraped.                        |
| `created_at`            | TIMESTAMP    | DEFAULT CURRENT_TIMESTAMP         | Timestamp when the lead was added to the database.             |
| `updated_at`            | TIMESTAMP    | DEFAULT CURRENT_TIMESTAMP         | Timestamp when the lead was last updated.                      |
| `whatsapp_message_sent` | BOOLEAN      | DEFAULT FALSE                     | Flag indicating if the automated WhatsApp message was sent.    |

### 4. `admins`

Stores credentials for admin panel users.

| Column Name     | Data Type    | Constraints        | Description                                  |
|-----------------|--------------|--------------------|----------------------------------------------|
| `admin_id`      | SERIAL       | PRIMARY KEY        | Unique identifier for the admin user.        |
| `username`      | VARCHAR(255) | UNIQUE NOT NULL    | Username for admin login.                    |
| `password_hash` | VARCHAR(255) | NOT NULL           | Hashed password for the admin user.          |
| `created_at`    | TIMESTAMP    | DEFAULT CURRENT_TIMESTAMP | Timestamp when the admin account was created. |

## Relationships

- **One-to-One**: `users` <-> `subscriptions` (A user has one subscription, identified by `user_id`)
- **One-to-Many**: `users` -> `leads` (A user can have many leads, linked by `user_id`)

## Notes

- Timestamps (`created_at`, `updated_at`) should ideally be managed automatically by the database or ORM.
- `whatsapp_session_data` in the `users` table will store the JSON required by `whatsapp-web.js` to resume sessions without re-scanning the QR code.
- The `leads` table uses `yad2_listing_id` as a unique constraint to prevent duplicate entries from the scraper.
- The `whatsapp_message_sent` flag helps ensure the automated message is sent only once per lead.
